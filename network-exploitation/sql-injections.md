# SQL Injections (SQLi)

## [Blind SQL Injection](https://owasp.org/www-community/attacks/Blind_SQL_Injection)

Blind SQLi is a type of SQL Injection attack that asks the database true or false questions and determines the answer based on the application's response. It is nearly identical to normal SQL Injection, the only difference being the way the data is retrieved from the database.

### Content-based Blind SQLi

This attack is often used when the web application is configured to show generic error messages, but has not mitigated the code that is vulnerable to SQL injection.

#### Example from Natas level15

```php
$link = mysql_connect('localhost', 'natas15', '<censored>');
mysql_select_db('natas15', $link);

$query = "SELECT * from users where username=\"".$_REQUEST["username"]."\"";

$res = mysql_query($query, $link);
if($res) {
    if(mysql_num_rows($res) > 0) {
        echo "This user exists.<br>";
    } else {
        echo "This user doesn't exist.<br>";
    }
} else {
    echo "Error in query.<br>";
}
```

In this example, the code is vulnerable but we cannot retrieve the results from the database. Instead, we can ask questions through SQLi like:

1. "Does the password start with `x`? `SELECT * from users where username="natas16" AND password LIKE BINARY "x%"`
2. "Does the password start with `xy`? `SELECT * from users where username="natas16" AND password LIKE BINARY "xy%"`
3. "Does the password start with `xyz`? `SELECT * from users where username="natas16" AND password LIKE BINARY "xyz%"`

<b><u>Note</u></b>: We use the `BINARY` keyword in order to perform a case-sensitive comparison in all cases. See [here](https://stackoverflow.com/questions/15504554/sql-vs-like-vs-like-binary-not-case-sensitive) for more in-depth information.

etc. Thus we construct slowly the password in this example.

### Time-based Blind SQLi

This type of blind SQL injection relies on the database pausing for a specified amount of time, then returning the results, indicating successful SQL query executing. Using this method, an attacker enumerates each letter of the desired piece of data using the following logic:

* If the first letter of the first database’s name is an `A`, wait for 10 seconds.
* If the first letter of the first database’s name is an `B`, wait for 10 seconds. etc.

Time-based techniques are often used to achieve tests when there is no other way to retrieve information from the database server. 

#### Time-based SQLi in MySQL DBMS

In MySQL DBMS we have two available expressions in order to achieve a time-based SQLi:

* `IF(expression, expr_true, expr_false)` - The `IF()` <i>function</i> will return the value of the expression `expr_true` if `expression` is evaluated to true, or the value of the expression `expr_false` if the `expression` is false.
  * As `expression` we ask the DBMS something, e.g. "Is the first letter of the `user_password` an `A`?
  * As `expr_true` we want to execute an operation that takes long enough to detect a delay in the response
  * As `expr_false` we want something that evaluates immediately
* `BENCHMARK(count, expr)` - This function will execute the given expression `expr` repeatedly `count` times.
  * An example of a `BENCHMARK` function that takes a long time to run (approximately 5 seconds) is:<br/>
  `BENCHMARK(5000000, ENCODE('MSG','by 5 seconds'))`

So, combining the above two primitives, we can extend the query that the webserver will execute with the following query

```sql
UNION SELECT IF(SUBSTRING(user_password,1,1) = CHAR(65), BENCHMARK(5000000, ENCODE('MSG','by 5 seconds')), null) FROM users WHERE user_id = 1;
```

Databases other than MySQL also have time-based functions which allow them to be used for time-based attacks (e.g. `pg_sleep()` in PostgreSQL)

#### Example

For an example of time-based SQLi with MySQL back-end DBMS, see level17 of Natas

## SQLi Payloads

In this section we will give references to SQL injection payloads for various DBMS systems.

* SQL Injections for [SQLite DBMS](https://www.exploit-db.com/docs/english/41397-injecting-sqlite-database-based-applications.pdf)
