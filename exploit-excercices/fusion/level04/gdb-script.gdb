

set confirm off

file /opt/fusion/bin/level04
delete breakpoints
set disassembly-flavor intel
set follow-fork-mode child

# Code has alarm(15);
handle SIGALRM ignore

define hook-stop
    x/5i $eip
    x/12wx $esp
    printf "$esp == (void*) 0x%08x\n", (void*)$esp
end

b *send_error

# set vars
b *validate_credentials+15
commands $bpnum
    silent
    set $vc_ra = $esp+0x84c+16
    set $vc_old_ebp = $esp+0x84c+12
    set $vc_ghb = $vc_ra
    continue
end

# Set stack canary for validate_credentials()
# 0xb7ffe15f <+15>:    mov    eax,gs:0x14
# 0xb7ffe165 <+21>:    mov    DWORD PTR [esp+0x83c],eax
b *validate_credentials+21
commands $bpnum
    silent
    set $vc_sc = $eax
    continue
end

# __stack_chk_fail_local() invoked in validate_credentials()
b *validate_credentials+370 
commands $bpnum
    printf "Expected stack canary is: 0x%08x\n", $vc_sc
    printf "Canary on stack is: 0x%08x\n", *((unsigned int*)($vc_ghb - 0x20))
end

# normal return of validate_credentials()
b *validate_credentials+351

set breakpoint pending on
b system
set breakpoint pending auto

set confirm on
#attach 7902
