#/bin/bash

# quite borken
# a few results were out of the expected memory page range of the binary
# but on other occasions it worked well

result=$(strings -a --radix=x /opt/fusion/bin/level03 | grep -Fe "$1" | head -n 1)
if [ "$result" = "" ]; then
    echo "No match"
    exit 0
fi

pattern='^ +([0-9a-fA-F]+) (.+)$' #  1341d .note.gnu.build-id

[[ $result =~ $pattern ]]

bin_offset=${BASH_REMATCH[1]}   #"1341d"
bin_offset=$(printf "%d" 0x$bin_offset) #78877
line=${BASH_REMATCH[2]} #.note.gnu.build-id

word=$(echo "$line" | grep -boFe "$1" | head -n 1)   #15:-i
pattern='^([0-9]+):(.+)$'

[[ $word =~ $pattern ]]

word_offset=${BASH_REMATCH[1]}   #15
word=${BASH_REMATCH[2]} #-i
if [ "$word" != "$1" ]; then
    echo "[ERROR] Mismatch '$word' with '$1'"
    exit 1
fi

offset=$(($bin_offset + $word_offset)) #78892

# Result printed: # 78892
printf "0x%08x\n" $offset

exit 0
