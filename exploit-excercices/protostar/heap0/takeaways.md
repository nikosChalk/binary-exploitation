

# Takeaways

## Finding out our heap allocator
First we need to find out what kind of heap allocator we are using. We are examining a C application linked against the default glibc:<br/>
```bash
user@protostar:~$ ldd /opt/protostar/bin/heap0
        linux-gate.so.1 =>  (0xb7fe4000)
        libc.so.6 => /lib/libc.so.6 (0xb7e99000)
        /lib/ld-linux.so.2 (0xb7fe5000)
user@protostar:~$ ls -l /lib/libc.so.6
lrwxrwxrwx 1 root root 14 Nov 22  2011 /lib/libc.so.6 -> libc-2.11.2.so
```
Thus we see that we are using glibc version 2.11.2 and we can explore its code through [bootlin](https://elixir.bootlin.com/glibc/glibc-2.11.2/source).

## Heap Layout
---
Let's examine `malloc/malloc.c` to find out the structure of the heap. Looking at [line 1810](https://elixir.bootlin.com/glibc/glibc-2.11.2/source/malloc/malloc.c#L1810) and down bellow, where the `struct malloc_chunk` is defined, we see how chunks are allocated and their layout in memory. Their layout depends if they are freed or not. The highlights are the following:

```C
An allocated chunk looks like this:


    chunk-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	        |             Size of previous chunk, if unallocated (P clear)| |
	        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	        |             Size of chunk, in bytes                       |M|P|
      mem-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	        |             User data starts here...                          .
	        .                                                               .
	        .             (malloc_usable_size() bytes)                      .
	        .                                                               |
nextchunk-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	        |             Size of chunk                                     |
	        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

Notes:
1. Chunks always begin on even word boundaries (p.x. sthn 2h leksh, 4h leksh, etc.) <==> 8-byte alignment
2. "chunk" is the front of the chunk for the purpose of most of the malloc code, but "mem" is the pointer that is returned to the user. "nextchunk" is the beginning of the next contiguous chunk.
3. `P` bit (PREV_INUSE) - Set if the previous chunk is in use
	- The very first chunk allocated always has this bit set, preventing access to non-existent (or non-owned) memory. If `P` bit is set for any given chunk, then you CANNOT determine the size of the previous chunk, and might even get a memory addressing fault when trying to do so.
4. `M` bit (IS_MMAPPED) - Set if the chunk has been allocated via mmap

Finally, in [line 1842](https://elixir.bootlin.com/glibc/glibc-2.11.2/source/malloc/malloc.c#L1842) there is a mistake in the documentation: "allocated" should be "unallocated". This is fixed in later versions, e.g. in [line 1080 of glibc-2.31](https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L1080)

TODO: determine the meaning of `| |` in the "size of previous chunk"
