
<?php
    // sry, this is ugly as hell.
    // cheers kaliman ;)
    // - morla
    
    class Logger {
        // "a+" - Open for reading and writing; place the file pointer at the end of the file.
        // If the file does not exist, attempt to create it.
        // In this mode, fseek() only affects the reading position, writes are always appended. 

        private $logFile;
        private $initMsg;
        private $exitMsg;
      
        function __construct($file){
            // initialise variables
            $this->initMsg="#--session started--#\n";
            $this->exitMsg="#--session end--#\n";
            $this->logFile = "/tmp/natas26_" . $file . ".log";
      
            // write initial message
            $fd=fopen($this->logFile,"a+");
            fwrite($fd,$initMsg);
            fclose($fd);
        }                       
      
        function log($msg){
            $fd=fopen($this->logFile,"a+");
            fwrite($fd,$msg."\n");
            fclose($fd);
        }                       
      
        function __destruct(){
            // write exit message
            $fd=fopen($this->logFile,"a+");
            fwrite($fd,$this->exitMsg);
            fclose($fd);
        }                       
    }
 
    //$filename="img/natas26_" . session_id() .".png"; 
    function showImage($filename){
        if(file_exists($filename))
            echo "<img src=\"$filename\">";
    }

    //$filename="img/natas26_" . session_id() .".png"; 
    function drawImage($filename){
        $img=imagecreatetruecolor(400,300);
        drawFromUserdata($img);     //draw on $img
        imagepng($img, $filename);  //output the $img to the given $filename as PNG
        imagedestroy($img);         //destroy the $img
    }
    
    /**
     * Draw in $img a line from user input x1,y1,x2,y2 present in GET request
     * If cookie "drawing" is also set, then draw all the lines stored there.
     * 
     * Example of Cookie "drawing" with value "YToyOntpOjA7YTo0OntzOjI6IngxIjtzOjA6IiI7czoyOiJ5MSI7czowOiIiO3M6MjoieDIiO3M6MDoiIjtzOjI6InkyIjtzOjA6IiI7fWk6MTthOjQ6e3M6MjoieDEiO3M6MToiMSI7czoyOiJ5MSI7czoxOiIyIjtzOjI6IngyIjtzOjE6IjMiO3M6MjoieTIiO3M6MToiNCI7fX0"
     * 1. Base64 decode the value
     * 2. Deserialize the vlaue
     * 3. Result is:
     *  array(2) {
     *      [0] => array(4) {
     *          'x1' => string(0) ""
     *          'y1' => string(0) ""
     *          'x2' => string(0) ""
     *          'y2' => string(0) ""
     *       }
     *      [1] => array(4) {
     *          'x1' => string(1) "1"
     *          'y1' => string(1) "2"
     *          'x2' => string(1) "3"
     *          'y2' => string(1) "4"
     *      }
     *   }
     */
    function drawFromUserdata($img){
        if( array_key_exists("x1", $_GET) && array_key_exists("y1", $_GET) &&
            array_key_exists("x2", $_GET) && array_key_exists("y2", $_GET)
        ) {
        
            $color=imagecolorallocate($img,0xff,0x12,0x1c);
            imageline($img,$_GET["x1"], $_GET["y1"], $_GET["x2"], $_GET["y2"], $color);
        }
        
        if (array_key_exists("drawing", $_COOKIE)){
            $drawing=unserialize(base64_decode($_COOKIE["drawing"]));   //PWN here
            if($drawing) {
                foreach($drawing as $object) {
                    if( array_key_exists("x1", $object) && 
                        array_key_exists("y1", $object) &&
                        array_key_exists("x2", $object) && 
                        array_key_exists("y2", $object)
                    ) {
                    
                        $color=imagecolorallocate($img,0xff,0x12,0x1c);
                        imageline($img,$object["x1"],$object["y1"], $object["x2"] ,$object["y2"] ,$color);
            
                    }
                }
            }
        }    
    }
    
    //Add the drawining to the cookie
    function storeData(){
        $new_object=array();

        if(array_key_exists("x1", $_GET) && array_key_exists("y1", $_GET) &&
            array_key_exists("x2", $_GET) && array_key_exists("y2", $_GET)
        ) {
            $new_object["x1"]=$_GET["x1"];
            $new_object["y1"]=$_GET["y1"];
            $new_object["x2"]=$_GET["x2"];
            $new_object["y2"]=$_GET["y2"];
        }
        
        if (array_key_exists("drawing", $_COOKIE)){
            $drawing=unserialize(base64_decode($_COOKIE["drawing"]));   //PWN here
        } else{
            // create new array
            $drawing=array();
        }
        
        $drawing[]=$new_object; //Append to the array
        setcookie("drawing",base64_encode(serialize($drawing)));
    }
?>

<form name="input" method="get">
    X1<input type="text" name="x1" size=2>
    Y1<input type="text" name="y1" size=2>
    X2<input type="text" name="x2" size=2>
    Y2<input type="text" name="y2" size=2>
    <input type="submit" value="DRAW!">
</form> 

<?php
    session_start();

    if (array_key_exists("drawing", $_COOKIE) ||
        (   array_key_exists("x1", $_GET) && array_key_exists("y1", $_GET) &&
            array_key_exists("x2", $_GET) && array_key_exists("y2", $_GET)
        )
    ) {  
        $imgfile="img/natas26_" . session_id() .".png"; 
        drawImage($imgfile); 
        showImage($imgfile);
        storeData();
    }
    
?>

