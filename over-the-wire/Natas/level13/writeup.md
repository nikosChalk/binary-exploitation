# Write up

To login in the domain `http://natas13.natas.labs.overthewire.org` use credentials:

Username: `natas13`<br/>
Password: `jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY`

This level is very similar to natas13, only the following check has been added

```php
if (! exif_imagetype($_FILES['uploadedfile']['tmp_name'])) {
    echo "File is not an image";
}
```
According to the [documentation](https://www.php.net/manual/en/function.exif-imagetype.php)
> `exif_imagetype()` reads the first bytes of an image and checks its signature. [...] When a correct signature is found, the appropriate constant value will be returned otherwise the return value is `FALSE`. [...] The following constants are defined, and represent possible `exif_imagetype()` return values:
>
> * 1 IMAGETYPE_GIF
> * 2 IMAGETYPE_JPEG
> * 3 IMAGETYPE_PNG
> * 4 IMAGETYPE_SWF
> * 5 IMAGETYPE_PSD
> * 6 IMAGETYPE_BMP
> * 7 IMAGETYPE_TIFF_II (intel byte order)
> * 8 IMAGETYPE_TIFF_MM (motorola byte order)
> * 9 IMAGETYPE_JPC
> * 10 IMAGETYPE_JP2
> * 11 IMAGETYPE_JPX
> * 12 IMAGETYPE_JB2
> * 13 IMAGETYPE_SWC
> * 14 IMAGETYPE_IFF
> * 15 IMAGETYPE_WBMP
> * 16 IMAGETYPE_XBM
> * 17 IMAGETYPE_ICO
> * 18 IMAGETYPE_WEBP

So we have to trick `exif_imagetype()` to return one of these constant values when supplied with a malicious PHP file. From the documentation we know that `exif_imagetype()` checks only the magic number of the file in order to determine the file type.

So, using a simple python script (<span>generate-payload.py</span>) we generate a file that:

1. Starts with the magic number of PNG files, i.e. `89 50 4E 47 0D 0A 1A 0A`
2. Contains PHP code that will print the contents of `/etc/natas_webpass/natas14` which contains the password for level natas14.

Thus by running the command `python generate-payload.py > payload.php`, uploading the file "payload.php", changing the suffix to ".php" in the `filname` input tag, and finally submitting the form, we are presented with a link, meaning that our file has been successfully uploaded and we tricked `exif_imagetype()`! Now if we follow the link, we are greeted with the password for level14, which is `Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1`.

So to login in the level14 use the credentials:

Username: `natas14`<br/>
Password: `Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1`
