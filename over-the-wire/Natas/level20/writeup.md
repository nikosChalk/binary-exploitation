# Write up

To login in the domain `http://natas20.natas.labs.overthewire.org` use credentials:

Username: `natas20`<br/>
Password: `eofm3Wsshxc5bwtVnEuGIlr7ivb9KABF`

The vulnerability can be found only if we examine the source code, so lets get into that. The server saves information associated with a particular session in a file that has the following format:

```txt
key1 value1
key2 value2
.... ......
keyN valueN
```

The key-value pairs are the corresponding key-value pairs in `$_SESSION` array. The file is written when the sessions is closed. When we send a post request through the form, we control the value stored in `$_SESSION["name"]`. Trying to guess the various `PHPSESSID`s and trying to find the one that corresponds to admin (like in previous challenges) is impossible since the session id is provided by the PHP implementation, which is considered secure. Can we find a way to modify `$_SESSION["admin"]` to change its value to `1` in some way?

Yes! If we manage to generate the following file

```txt
name AAAA
admin 1
```

then when the file is read, we will have `$_SESSION["name"] = "AAAA"` (irrelevant for the credential printing) and `$_SESSION["admin"] = "1"` So the comparison `$_SESSION["admin"] == 1` will evaluate to `"1" == 1` which will evaluate to `True`. (See [PHP string conversion to numbers](https://www.php.net/manual/en/language.types.string.php#language.types.string.conversion))

So can we generate this file? Yes! There is no sanitization in the input, so whatever value is sent, it will be stored in the file as the value of the key `name`. So if we send the URL encoded input `AAAA%0aadmin+1` and then close the connection with the header `Connection: Close`, the above file will be generated since `%0a` stands for `\n`. In fact, we can insert into `$_SESSION` any arbitrary string key-value pair that we want.

Now if we send a GET request with the same `PHPSESSID`, the file will be read, the `$_SESSION` will be populated with our malicious key-value pair and we will be presented with the password for level21, which is `IFekPyrQXftziDEsUr3x21sYuahypdgJ`

So to login in the level21 use the credentials:

Username: `natas21`<br/>
Password: `IFekPyrQXftziDEsUr3x21sYuahypdgJ`
